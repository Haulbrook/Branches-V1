<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Map - Deep Roots Landscape</title>
    <!-- v1.0 - Job Location Mapping from Work Orders -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --brand-primary: #2E7D32;
            --brand-primary-dark: #1B5E20;
            --brand-primary-light: #4CAF50;
            --brand-accent: #FFA726;
            --success: #66BB6A;
            --warning: #FFA726;
            --error: #EF5350;
            --info: #42A5F5;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #EEEEEE;
            --gray-300: #E0E0E0;
            --gray-600: #757575;
            --gray-800: #424242;
            --gray-900: #212121;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: white;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-primary-dark) 100%);
            color: white;
            padding: 20px;
        }

        .sidebar-header h1 {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header p {
            font-size: 0.8em;
            opacity: 0.9;
        }

        .stats-bar {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.7em;
            opacity: 0.8;
        }

        /* Search */
        .search-section {
            padding: 15px;
            border-bottom: 1px solid var(--gray-200);
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.9em;
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        /* Job List */
        .job-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .job-card {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid var(--brand-primary);
        }

        .job-card:hover {
            background: white;
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .job-card.selected {
            background: rgba(46, 125, 50, 0.1);
            border-left-color: var(--brand-accent);
        }

        .job-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .job-wo {
            font-size: 0.7em;
            font-weight: 600;
            color: var(--brand-primary);
            background: rgba(46, 125, 50, 0.1);
            padding: 3px 6px;
            border-radius: 4px;
        }

        .job-category {
            font-size: 0.65em;
            font-weight: 500;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            background: var(--info);
        }

        .job-category.enhancements { background: var(--warning); }
        .job-category.installation { background: var(--brand-primary); }
        .job-category.irrigation { background: var(--info); }

        .job-name {
            font-size: 0.95em;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .job-client {
            font-size: 0.8em;
            color: var(--gray-600);
            margin-bottom: 6px;
        }

        .job-address {
            font-size: 0.75em;
            color: var(--gray-600);
            display: flex;
            align-items: flex-start;
            gap: 5px;
        }

        .job-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--gray-200);
            font-size: 0.75em;
            color: var(--gray-600);
        }

        .job-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-navigate {
            background: var(--brand-primary);
            color: white;
        }

        .btn-navigate:hover {
            background: var(--brand-primary-dark);
        }

        .btn-details {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .btn-details:hover {
            background: var(--gray-300);
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-btn {
            width: 44px;
            height: 44px;
            background: white;
            border: none;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .map-btn:hover {
            background: var(--gray-100);
            transform: scale(1.05);
        }

        /* Info Panel */
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            max-width: 400px;
        }

        .info-panel.visible {
            display: block;
        }

        .info-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .info-panel h3 {
            font-size: 1em;
            color: var(--gray-900);
            margin: 0;
        }

        .info-panel-close {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--gray-600);
        }

        .info-panel p {
            font-size: 0.85em;
            color: var(--gray-600);
            margin-bottom: 10px;
        }

        .info-panel-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--brand-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--brand-primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-600);
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 1em;
            margin-bottom: 8px;
        }

        .empty-state-subtext {
            font-size: 0.85em;
            opacity: 0.7;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }
        .toast.info { background: var(--info); }

        /* Leaflet Popup Customization */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .leaflet-popup-content {
            margin: 12px;
        }

        .popup-title {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .popup-client {
            font-size: 0.85em;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .popup-address {
            font-size: 0.8em;
            color: var(--gray-600);
        }

        .popup-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 6px 12px;
            background: var(--brand-primary);
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 40vh;
            }

            .map-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üó∫Ô∏è Logistics Map</h1>
                <p>Job locations from imported work orders</p>
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-value" id="totalJobs">0</div>
                        <div class="stat-label">Jobs</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mappedJobs">0</div>
                        <div class="stat-label">Mapped</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="unmappedJobs">0</div>
                        <div class="stat-label">No Location</div>
                    </div>
                </div>
            </div>

            <div class="search-section">
                <input type="text" class="search-input" id="searchInput" placeholder="Search jobs, clients, addresses...">
            </div>

            <div class="job-list" id="jobList">
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <div class="empty-state-text">No work orders found</div>
                    <div class="empty-state-subtext">Import work orders using the Work Order Import tool</div>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>

            <div class="map-controls">
                <button class="map-btn" onclick="fitAllMarkers()" title="Show all jobs">üéØ</button>
                <button class="map-btn" onclick="toggleSatellite()" title="Toggle satellite view">üõ∞Ô∏è</button>
                <button class="map-btn" onclick="refreshData()" title="Refresh data">üîÑ</button>
            </div>

            <div class="info-panel" id="infoPanel">
                <div class="info-panel-header">
                    <h3 id="infoPanelTitle">Job Name</h3>
                    <button class="info-panel-close" onclick="closeInfoPanel()">√ó</button>
                </div>
                <p id="infoPanelAddress">Address</p>
                <div id="infoPanelProgress"></div>
                <div class="info-panel-actions">
                    <button class="btn btn-primary" onclick="navigateToSelected()">üß≠ Navigate</button>
                    <button class="btn btn-secondary" onclick="openProgressTracker()">üìä Details</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Sync Module -->
    <script src="js/workOrderSync.js"></script>

    <script>
        // State
        let workOrders = [];
        let map = null;
        let markers = [];
        let selectedJob = null;
        let satelliteView = false;
        let tileLayer = null;

        // Gainesville, GA as default center (Deep Roots area)
        const DEFAULT_CENTER = [34.2979, -83.8241];
        const DEFAULT_ZOOM = 10;

        // Initialize
        function init() {
            initMap();
            loadWorkOrders();
            setupEventListeners();
        }

        // Initialize Leaflet Map
        function initMap() {
            map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);

            tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Toggle satellite view
        function toggleSatellite() {
            map.removeLayer(tileLayer);

            if (satelliteView) {
                tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            } else {
                tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri'
                }).addTo(map);
            }

            satelliteView = !satelliteView;
            showToast(satelliteView ? 'Satellite view' : 'Street view', 'info');
        }

        // Load work orders from localStorage
        function loadWorkOrders() {
            try {
                const stored = localStorage.getItem('workOrders');
                workOrders = stored ? JSON.parse(stored) : [];

                updateStats();
                renderJobList();
                geocodeAndPlaceMarkers();

            } catch (error) {
                console.error('Error loading work orders:', error);
                showToast('Error loading work orders', 'error');
            }
        }

        // Update stats
        function updateStats() {
            const total = workOrders.length;
            const mapped = workOrders.filter(wo => wo.address && wo.address.trim()).length;
            const unmapped = total - mapped;

            document.getElementById('totalJobs').textContent = total;
            document.getElementById('mappedJobs').textContent = mapped;
            document.getElementById('unmappedJobs').textContent = unmapped;
        }

        // Render job list in sidebar
        function renderJobList(filter = '') {
            const container = document.getElementById('jobList');

            let filteredJobs = workOrders;
            if (filter) {
                const searchTerm = filter.toLowerCase();
                filteredJobs = workOrders.filter(wo =>
                    wo.woNumber?.toLowerCase().includes(searchTerm) ||
                    wo.jobName?.toLowerCase().includes(searchTerm) ||
                    wo.client?.toLowerCase().includes(searchTerm) ||
                    wo.address?.toLowerCase().includes(searchTerm) ||
                    wo.salesRep?.toLowerCase().includes(searchTerm)
                );
            }

            if (filteredJobs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${filter ? 'üîç' : 'üì≠'}</div>
                        <div class="empty-state-text">${filter ? 'No matching jobs' : 'No work orders found'}</div>
                        <div class="empty-state-subtext">${filter ? 'Try a different search term' : 'Import work orders using the Work Order Import tool'}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredJobs.map(wo => {
                const categoryClass = wo.category?.toLowerCase().replace(/\s+/g, '-') || '';
                const hasAddress = wo.address && wo.address.trim();

                return `
                    <div class="job-card ${selectedJob?.woNumber === wo.woNumber ? 'selected' : ''}"
                         data-wo="${wo.woNumber}"
                         onclick="selectJob('${wo.woNumber}')">
                        <div class="job-card-header">
                            <span class="job-wo">WO# ${wo.woNumber}</span>
                            <span class="job-category ${categoryClass}">${wo.category || 'General'}</span>
                        </div>
                        <div class="job-name">${wo.jobName}</div>
                        <div class="job-client">üë§ ${wo.client}</div>
                        <div class="job-address">
                            <span>${hasAddress ? 'üìç' : '‚ö†Ô∏è'}</span>
                            <span>${wo.address || 'No address provided'}</span>
                        </div>
                        <div class="job-meta">
                            <span>üëî ${wo.salesRep || 'Unassigned'}</span>
                            <div class="job-actions">
                                ${hasAddress ? `<button class="btn-small btn-navigate" onclick="event.stopPropagation(); navigateTo('${wo.woNumber}')">üß≠ Nav</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Geocode addresses and place markers
        async function geocodeAndPlaceMarkers() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const jobsWithAddress = workOrders.filter(wo => wo.address && wo.address.trim());

            if (jobsWithAddress.length === 0) {
                showToast('No jobs with addresses to map', 'info');
                return;
            }

            showToast(`Geocoding ${jobsWithAddress.length} addresses...`, 'info');

            let geocoded = 0;
            let failed = 0;

            for (const wo of jobsWithAddress) {
                try {
                    // Check if we have cached coordinates
                    const cacheKey = `geo_${wo.woNumber}`;
                    let coords = localStorage.getItem(cacheKey);

                    if (coords) {
                        coords = JSON.parse(coords);
                    } else {
                        // Geocode using Nominatim
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(wo.address)}&limit=1`,
                            { headers: { 'User-Agent': 'DeepRootsLogistics/1.0' } }
                        );
                        const data = await response.json();

                        if (data && data.length > 0) {
                            coords = {
                                lat: parseFloat(data[0].lat),
                                lng: parseFloat(data[0].lon)
                            };
                            // Cache the result
                            localStorage.setItem(cacheKey, JSON.stringify(coords));
                        } else {
                            failed++;
                            continue;
                        }

                        // Rate limiting - be nice to Nominatim
                        await new Promise(r => setTimeout(r, 1000));
                    }

                    // Create marker
                    const marker = L.marker([coords.lat, coords.lng])
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">WO# ${wo.woNumber} - ${wo.jobName}</div>
                            <div class="popup-client">üë§ ${wo.client}</div>
                            <div class="popup-address">üìç ${wo.address}</div>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(wo.address)}"
                               target="_blank" class="popup-btn">üß≠ Navigate</a>
                        `);

                    marker.woNumber = wo.woNumber;
                    marker.on('click', () => selectJob(wo.woNumber));
                    markers.push(marker);
                    geocoded++;

                } catch (error) {
                    console.error(`Failed to geocode ${wo.address}:`, error);
                    failed++;
                }
            }

            showToast(`Mapped ${geocoded} jobs${failed > 0 ? `, ${failed} failed` : ''}`, geocoded > 0 ? 'success' : 'error');

            // Fit map to markers
            if (markers.length > 0) {
                fitAllMarkers();
            }
        }

        // Fit all markers in view
        function fitAllMarkers() {
            if (markers.length === 0) {
                map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
                return;
            }

            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        // Select a job
        function selectJob(woNumber) {
            selectedJob = workOrders.find(wo => wo.woNumber === woNumber);

            // Update sidebar
            document.querySelectorAll('.job-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.wo === woNumber);
            });

            // Find and highlight marker
            const marker = markers.find(m => m.woNumber === woNumber);
            if (marker) {
                map.setView(marker.getLatLng(), 15);
                marker.openPopup();
            }

            // Show info panel
            if (selectedJob) {
                document.getElementById('infoPanelTitle').textContent = `WO# ${selectedJob.woNumber} - ${selectedJob.jobName}`;
                document.getElementById('infoPanelAddress').textContent = 'üìç ' + (selectedJob.address || 'No address');

                // Render progress widget
                const progressContainer = document.getElementById('infoPanelProgress');
                if (progressContainer && typeof ProgressWidget !== 'undefined') {
                    progressContainer.innerHTML = ProgressWidget.render(selectedJob.woNumber, 'full');
                }

                document.getElementById('infoPanel').classList.add('visible');
            }
        }

        // Navigate to job
        function navigateTo(woNumber) {
            const job = workOrders.find(wo => wo.woNumber === woNumber);
            if (job && job.address) {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(job.address)}`, '_blank');
            }
        }

        // Navigate to selected job
        function navigateToSelected() {
            if (selectedJob && selectedJob.address) {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(selectedJob.address)}`, '_blank');
            }
        }

        // Open progress tracker for selected job
        function openProgressTracker() {
            if (selectedJob) {
                window.open(`progress-tracker.html?wo=${selectedJob.woNumber}`, '_blank');
            }
        }

        // Close info panel
        function closeInfoPanel() {
            document.getElementById('infoPanel').classList.remove('visible');
            selectedJob = null;
            document.querySelectorAll('.job-card').forEach(card => card.classList.remove('selected'));
        }

        // Refresh data
        function refreshData() {
            loadWorkOrders();
            showToast('Data refreshed', 'success');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                renderJobList(e.target.value);
            });

            // Listen for work order updates
            window.addEventListener('storage', (e) => {
                if (e.key === 'workOrders') {
                    loadWorkOrders();
                }
            });

            // Listen for sync updates
            window.addEventListener('workOrderSync:workOrdersUpdated', (e) => {
                loadWorkOrders();
            });

            window.addEventListener('workOrdersUpdated', (e) => {
                loadWorkOrders();
            });
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Initialize on load
        init();
    </script>

    <!-- Progress Widget -->
    <script src="js/progressWidget.js"></script>
</body>
</html>
